macro(MEEDDetectPlatform)
    message(STATUS "CMAKE_SYSTEM_NAME: ${CMAKE_SYSTEM_NAME}")
    set(PLATFORM_IS_LINUX OFF)
    set(PLATFORM_IS_WINDOWS OFF)
    set(PLATFORM_IS_WEB OFF)

    if (CMAKE_SYSTEM_NAME STREQUAL "Linux")
        set(PLATFORM_DEFINITION PLATFORM_IS_LINUX=1)
        set(PLATFORM_IS_LINUX ON)
    elseif (CMAKE_SYSTEM_NAME STREQUAL "Windows")
        set(PLATFORM_DEFINITION PLATFORM_IS_WINDOWS=1)
        set(PLATFORM_IS_WINDOWS ON)
    elseif (CMAKE_SYSTEM_NAME STREQUAL "Emscripten")
        set(PLATFORM_DEFINITION PLATFORM_IS_WEB=1)
        set(PLATFORM_IS_WEB ON)
    else()
        message(FATAL "The system is not supported by this engine")
    endif()
endmacro()

macro(MEEDOption OPTION DEFAULT_VALUE)
    option(${OPTION} "Enable ${OPTION}" ${DEFAULT_VALUE})

    if (${OPTION} STREQUAL "ON")
        list(APPEND COMMON_DEFINITIONS ${OPTION}=1)
    elseif (${OPTION} STREQUAL "OFF")
        list(APPEND COMMON_DEFINITIONS ${OPTION}=0)
    else()
        list(APPEND COMMON_DEFINITIONS ${OPTION}=${${OPTION}})
    endif()
endmacro()

macro(MdSetupRenderAPI)
    MEEDOption(MD_USE_VULKAN ON)
    MEEDOption(MD_USE_OPENGL OFF)

    if (MD_USE_VULKAN AND MD_USE_OPENGL)
        message(WARNING "Cannot enable both Vulkan and OpenGL support simultaneously. Disabling OpenGL support.")
        set(MD_USE_OPENGL OFF CACHE BOOL "Disable OpenGL support" FORCE)
        list(REMOVE_ITEM COMMON_DEFINITIONS "MD_USE_OPENGL=1")
    endif()

    if (NOT MD_USE_VULKAN AND NOT MD_USE_OPENGL)
        message(WARNING "At least one graphics API must be enabled. Enabling Vulkan support by default.")
        set(MD_USE_VULKAN ON CACHE BOOL "Enable Vulkan support" FORCE)
        list(APPEND COMMON_DEFINITIONS "MD_USE_VULKAN=1")
    endif()
    
    if (PLATFORM_IS_WEB)
        if (MD_USE_VULKAN STREQUAL "ON")
            message(WARNING "Vulkan is not supported on Web platform. Disabling MD_USE_VULKAN. Use OpenGL instead.")
            set(MD_USE_VULKAN OFF CACHE BOOL "Disable Vulkan on Web platform" FORCE)
            set(MD_USE_OPENGL ON CACHE BOOL "Enable OpenGL on Web platform" FORCE)
            list(REMOVE_ITEM COMMON_DEFINITIONS "MD_USE_VULKAN=1")
            list(APPEND COMMON_DEFINITIONS "MD_USE_OPENGL=1")
        endif()
    endif()

    if (MD_USE_VULKAN)
        message(STATUS "Render API: Vulkan")
    elseif (MD_USE_OPENGL)
        message(STATUS "Render API: OpenGL")
    else()
        message(FATAL "No valid Render API selected.")
    endif()
endmacro()

macro(MdSetup)
    set(PROJECT_BASE_DIR "{{ BASE_DIR }}")
    set(EXTERNALS_DIR "{{ BASE_DIR }}/externals")
    set(CMAKE_MODULE_DIR "{{ BASE_DIR }}/cmake")
    set(COMMON_OPTIONS "")
    set(COMMON_DEFINITIONS "")

    if (MSVC)
        set_property(GLOBAL PROPERTY USE_FOLDERS ON)
    endif()

    MEEDOption(CMAKE_BUILD_TYPE Debug)
    MEEDDetectPlatform()

    list(APPEND COMMON_DEFINITIONS "${PLATFORM_DEFINITION}")
    list(APPEND COMMON_DEFINITIONS "PROJECT_BASE_DIR=${PROJECT_BASE_DIR}")

    MdSetupRenderAPI()

    if (CMAKE_BUILD_TYPE STREQUAL "Debug")
        list(APPEND COMMON_DEFINITIONS MD_DEBUG=1)
        set(MD_DEBUG ON)
        set(MD_RELEASE OFF)
    else()
        list(APPEND COMMON_DEFINITIONS MD_RELEASE=1)
        set(MD_DEBUG OFF)
        set(MD_RELEASE ON)
    endif()
endmacro()

macro(MEEDFindPackage PACKAGE_NAME FOLDER)
    set(CMAKE_FOLDER ${FOLDER})

    set(${PACKAGE_NAME}_DIR "${CMAKE_MODULE_DIR}")

    find_package(${PACKAGE_NAME} REQUIRED)
    unset(CMAKE_FOLDER)

    if (PLATFORM_IS_LINUX)
        set(CMAKE_C_FLAGS "-m64")
        set(CMAKE_CXX_FLAGS "-m64")
    endif()
endmacro()

function(MEEDLog VARIABLE)
    message(STATUS "${VARIABLE}: ${${VARIABLE}}")
endfunction()