macro(MEEDDetectPlatform)
    message(STATUS "CMAKE_SYSTEM_NAME: ${CMAKE_SYSTEM_NAME}")
    set(LINUX_BUILD OFF)
    set(WINDOW_BUILD OFF)
    set(WEB_BUILD OFF)

    if (CMAKE_SYSTEM_NAME STREQUAL "Linux")
        set(PLATFORM_DEFINITION PLATFORM_IS_LINUX)
        set(LINUX_BUILD ON)
    elseif (CMAKE_SYSTEM_NAME STREQUAL "Windows")
        set(PLATFORM_DEFINITION PLATFORM_IS_WINDOWS)
        set(WINDOW_BUILD ON)
    elseif (CMAKE_SYSTEM_NAME STREQUAL "Emscripten")
        set(PLATFORM_DEFINITION PLATFORM_IS_WEB)
        set(WEB_BUILD ON)
    else()
        message(FATAL "The system is not supported by this engine")
    endif()
endmacro()

macro(MEEDOption OPTION DEFAULT_VALUE)
    option(${OPTION} "Enable ${OPTION}" ${DEFAULT_VALUE})

    if (${OPTION} STREQUAL "ON")
        list(APPEND COMMON_DEFINITIONS ${OPTION}=1)
    elseif (${OPTION} STREQUAL "OFF")
        list(APPEND COMMON_DEFINITIONS ${OPTION}=0)
    else()
        list(APPEND COMMON_DEFINITIONS ${OPTION}=${${OPTION}})
    endif()
endmacro()

macro(MEEDSetup)
    set(PROJECT_BASE_DIR "{{ BASE_DIR }}")
    set(EXTERNALS_DIR "{{ BASE_DIR }}/externals")
    set(CMAKE_MODULE_DIR "{{ BASE_DIR }}/cmake")

    MEEDOption(CMAKE_BUILD_TYPE Debug)
    MEEDOption(MEED_USE_VULKAN ON)

    MEEDDetectPlatform()

    list(APPEND COMMON_DEFINITIONS "${PLATFORM_DEFINITION}")
    list(APPEND COMMON_DEFINITIONS "PROJECT_BASE_DIR=${PROJECT_BASE_DIR}")

    if (CMAKE_BUILD_TYPE STREQUAL "Debug")
        list(APPEND COMMON_DEFINITIONS MEED_DEBUG)
    else()
        list(APPEND COMMON_DEFINITIONS MEED_RELEASE)
    endif()

    if (WEB_BUILD)
        if (MEED_USE_VULKAN STREQUAL "ON")
            message(WARNING "Vulkan is not supported on Web platform. Disabling MEED_USE_VULKAN.")
            set(MEED_USE_VULKAN OFF CACHE BOOL "Disable Vulkan on Web platform" FORCE)
            list(REMOVE_ITEM COMMON_DEFINITIONS "MEED_USE_VULKAN=1")
        endif()
    endif()

    message(STATUS "Platform Definitions: ${COMMON_DEFINITIONS}")
endmacro()

macro(MEEDFindPackage PACKAGE_NAME FOLDER)
    set(CMAKE_FOLDER ${FOLDER})

    if (WEB_BUILD)
        set(MEEDEngine_DIR "${CMAKE_MODULE_DIR}")
    endif()

    find_package(${PACKAGE_NAME} REQUIRED PATHS ${CMAKE_MODULE_DIR})
    unset(CMAKE_FOLDER CACHE)

    if (NOT WEB_BUILD)
        set(CMAKE_C_FLAGS "-m64")
        set(CMAKE_CXX_FLAGS "-m64")
    endif()
endmacro()